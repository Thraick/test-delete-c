<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<style>
  body {font-family:system-ui,sans-serif;background:#0d1117;color:#e6edf3;margin:0;padding:20px;}
  h1 {text-align:center;margin:0 0 8px;}
  .sub {text-align:center;color:#8b949e;margin-bottom:20px;}
  .btn {padding:10px 20px;border:none;border-radius:8px;color:white;cursor:pointer;margin:0 5px;}
  .refresh {background:#238636;} .refresh:hover {background:#2ea44f;}
  .manage {background:#6f42c1;} .manage:hover {background:#8250df;}
  .columns {background:#1f6feb;} .columns:hover {background:#388bfd;}
  .panel {position:fixed;top:70px;right:20px;background:#161b22;border:1px solid #30363d;border-radius:10px;padding:20px;box-shadow:0 8px 25px rgba(0,0,0,.6);z-index:1000;display:none;width:300px;max-height:80vh;overflow-y:auto;}
  .panel input {width:100%;padding:10px;margin:10px 0;border-radius:6px;border:1px solid #30363d;background:#0d1117;color:white;}
  .coin-list {max-height:300px;overflow-y:auto;}
  .coin-item {display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #30363d;}
  .remove {background:#da3633;color:white;padding:6px 12px;border:none;border-radius:6px;cursor:pointer;font-size:12px;}
  table {width:100%;border-collapse:collapse;background:#161b22;border-radius:12px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,.5);}
  th, td {padding:14px;text-align:right;border-bottom:1px solid #30363d;}
  th {background:#21262d;cursor:pointer;user-select:none;}
  th:hover {background:#30363d;}
  th:first-child, td:first-child {text-align:left;}
  .symbol {color:#58a6ff;font-weight:bold;cursor:pointer;}
  .symbol:hover {text-decoration:underline;}
  .pos {color:#26a641;font-weight:bold;}
  .neg {color:#da3633;font-weight:bold;}
  .zero {color:#8b949e;}
  .details {display:none;}
  .buy-btn {background:#26a641;color:white;padding:10px 20px;border:none;border-radius:6px;cursor:pointer;margin:0 8px;}
  .sell-btn {background:#da3633;color:white;padding:10px 20px;border:none;border-radius:6px;cursor:pointer;}
  input.amt {padding:10px;width:140px;border-radius:6px;border:1px solid #30363d;background:#161b22;color:white;}
  .loading {text-align:center;padding:60px;color:#8b949e;}
  .footer {text-align:center;margin:40px 0 20px;color:#8b949e;font-size:14px;}
</style>
</head>
<body>

<!-- <h1>My Crypto Tracker</h1>
<p class="sub">Add/remove coins • Profits forever • Offline after load</p> -->

<div style="text-align:center;margin-bottom:20px;">
  <button class="btn refresh" onclick="refreshData(true)">Refresh Prices</button>
  <button class="btn manage" onclick="togglePanel('managePanel')">Manage Coins</button>
  <button class="btn columns" onclick="togglePanel('colPanel')">Columns</button>
  <span id="last" style="margin-left:20px;color:#8b949e;"></span>
</div>

<!-- Manage Coins Panel -->
<div class="panel" id="managePanel">
  <h3>Add / Remove Coins</h3>
  <input type="text" id="newSymbol" placeholder="e.g. PEPEUSDT, FLOKIUSDT" style="text-transform:uppercase;">
  <button class="btn" style="background:#238636;width:100%;margin-top:8px;" onclick="addCoin()">Add Coin</button>
  <div class="coin-list" id="coinList"></div>
  <button class="btn" style="background:#da3633;width:100%;margin-top:10px;" onclick="togglePanel('managePanel')">Close</button>
</div>

<!-- Columns Panel -->
<div class="panel" id="colPanel">
  <h4>Hide Columns</h4>
  <label><input type="checkbox" checked data-col="changes"> Changes</label>
  <label><input type="checkbox" checked data-col="24h"> 24h %</label>
  <label><input type="checkbox" checked data-col="7d"> 7d %</label>
  <label><input type="checkbox" checked data-col="30d"> 30d %</label>
  <label><input type="checkbox" checked data-col="price"> Price</label>
  <label><input type="checkbox" checked data-col="avg"> Avg Price</label>
  <label><input type="checkbox" checked data-col="high"> Avg High</label>
  <label><input type="checkbox" checked data-col="low"> Avg Low</label>
  <label><input type="checkbox" checked data-col="profit"> Profit</label>
  <button class="btn" style="background:#da3633;width:100%;margin-top:10px;" onclick="togglePanel('colPanel')">Close</button>
</div>

<table id="table">
  <thead id="thead">
    <tr>
      <th data-col="crypto" onclick="sort(0)">Crypto</th>
      <th data-col="changes" onclick="sort(1)">Changes</th>
      <th data-col="24h" onclick="sort(2)">24h %</th>
      <th data-col="7d" onclick="sort(3)">7d %</th>
      <th data-col="30d" onclick="sort(4)">30d %</th>
      <th data-col="price" onclick="sort(5)">Price</th>
      <th data-col="avg" onclick="sort(6)">Avg Price</th>
      <th data-col="high" onclick="sort(7)">Avg High</th>
      <th data-col="low" onclick="sort(8)">Avg Low</th>
      <th data-col="profit">Profit</th>
    </tr>
  </thead>
  <tbody id="body">
    <tr><td colspan="10" class="loading">Loading...</td></tr>
  </tbody>
</table>

<!-- <div class="footer">Trades saved forever • Micro-coin precision • Not financial advice</div> -->

<script>
const { DateTime } = luxon;
let data = {}, positions = {}, myCoins = [];
let sortCol = 1, asc = false;
let visibleCols = {changes:true,'24h':true,'7d':true,'30d':true,price:true,avg:true,high:true,low:true,profit:true};
const CACHE = "crypto_fixed_v9";
// const DEFAULT_COINS = ["1MBABYDOGEUSDT","BTCUSDT","ETHUSDT","SOLUSDT","PEPEUSDT","DOGEUSDT"];
const DEFAULT_COINS =[
    "FISUSDT", "1MBABYDOGEUSDT",
    "BTCUSDT", "ETHUSDT", "USDTUSDT", "XRPUSDT", "BNBUSDT", "SOLUSDT",
    "USDCUSDT", "TRXUSDT", "DOGEUSDT", "ADAUSDT", "AVAXUSDT",
    "SHIBUSDT", "LINKUSDT", "DOTUSDT", "MATICUSDT", "LTCUSDT",
    "UNIUSDT", "TONUSDT", "NEARUSDT", "ICPUSDT", "KSMUSDT", "HBARUSDT",
    "AAVEUSDT", "XLMUSDT", "ETCUSDT", "FDUSDUSDT", "BCHUSDT", "SUIUSDT",
    "MKRUSDT", "TAOUSDT", "WLFIUSDT", "THETAUSDT", "VETUSDT", "FILUSDT",
    "ATOMUSDT", "GRTUSDT", "OPUSDT", "INJUSDT", "ARBUSDT", "LDOUSDT",
    "JUPUSDT", "IMXUSDT", "FLOKIUSDT", "RNDRUSDT", "STXUSDT",
    "WIFUSDT", "TIAUSDT",
    "LUNCUSDT", "LUNAUSDT", "CVCUSDT", "USTCUSDT", "YBUSDT", "EGLDUSDT",
    "SAPIENUSDT", "FTTUSDT", "SYRUPUSDT", "NMRUSDT", "PEPEUSDT",
    "HEMIUSDT", "VOXELUSDT", "ALLOUSDT", "SXPUSDT", "RAYUSDT",
    "MAGICUSDT", "SOMIUSDT", "SNXUSDT", "REZUSDT", "ZECUSDT",
    "BONKUSDT", "GLMUSDT", "FLUXUSDT", "STORJUSDT", "FETUSDT",
    "BTTCUSDT", "MINAUSDT", "DASHUSDT", "ZKUSDT", "VIRTUALUSDT",
    "MORPHOUSDT"
];

function save() {
  localStorage.setItem(CACHE, JSON.stringify({data, positions, myCoins, visibleCols}));
  document.getElementById("last").textContent = "Updated " + DateTime.now().toLocaleString(DateTime.DATETIME_MED_WITH_SECONDS);
}

function load() {
  const s = localStorage.getItem(CACHE);
  if (s) {
    const tmp = JSON.parse(s);
    data = tmp.data || {};
    positions = tmp.positions || {};
    myCoins = tmp.myCoins || DEFAULT_COINS;
    visibleCols = tmp.visibleCols || visibleCols;
  } else {
    myCoins = [...DEFAULT_COINS];
    save();
  }
  updateColVisibility();
  renderCoinList();
}

function formatPrice(p) {
  if (p < 0.000001) return "$" + p.toExponential(4);
  if (p < 0.01) return "$" + p.toFixed(8).replace(/\.?0+$/, '');
  if (p < 1) return "$" + p.toFixed(6).replace(/\.?0+$/, '');
  return "$" + p.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
}

async function getTickers() {
  const res = await fetch("https://api.binance.com/api/v3/ticker/24hr");
  const arr = await res.json();
  return Object.fromEntries(arr.map(t => [t.symbol, t]));
}

async function getKlines(sym) {
  const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${sym}&interval=1d&limit=35`);
  const k = await res.json();
  const closes = k.map(x => parseFloat(x[4]));
  const highs = k.map(x => parseFloat(x[2]));
  const lows = k.map(x => parseFloat(x[3]));
  const avg = a => a.reduce((x, y) => x + y, 0) / a.length;
  const cur = closes[closes.length - 1];
  const past24 = closes[closes.length - 2] || cur;
  const past7 = closes[closes.length - 8] || cur;
  const past30 = closes[0] || cur;
  return {
    price: cur,
    avgPrice: avg(closes),
    avgHigh: avg(highs),
    avgLow: avg(lows),
    change24h: (cur - past24) / past24 * 100,
    change7d: (cur - past7) / past7 * 100,
    change30d: (cur - past30) / past30 * 100,
    vsAvg: (cur - avg(closes)) / avg(closes) * 100
  };
}

async function refreshData(force = false) {
  document.getElementById("body").innerHTML = '<tr><td colspan="10" class="loading">Updating...</td></tr>';
  if (!force) load();
  const tickers = await getTickers();

  for (const sym of myCoins) {
    if (force || !data[sym]) {
      try {
        const k = await getKlines(sym);
        const t = tickers[sym] || {};
        data[sym] = {
          sym: sym.replace("USDT", ""),
          price: parseFloat(t.lastPrice || k.price),
          change24h: parseFloat(t.priceChangePercent || k.change24h),
          change7d: k.change7d,
          change30d: k.change30d,
          avgPrice: k.avgPrice,
          avgHigh: k.avgHigh,
          avgLow: k.avgLow,
          vsAvg: k.vsAvg
        };
      } catch (e) {
        console.error("Error fetching " + sym, e);
      }
    }
  }
  save();
  render();
}

function calcProfit(sym) {
  const coin = data[sym + "USDT"] || Object.values(data).find(c => c.sym === sym);
  const pos = positions[sym] || {coins: 0, buyPrice: 0};
  if (pos.coins === 0) return {profit: 0, pct: 0};
  const profit = (coin.price - pos.buyPrice) * pos.coins;
  const pct = (coin.price - pos.buyPrice) / pos.buyPrice * 100;
  return {profit, pct};
}

function render() {
  const tbody = document.getElementById("body");
  let rows = myCoins.map(s => data[s]).filter(Boolean);

  // Sorting
  rows.sort((a, b) => {
    let A = sortCol === 0 ? a.sym.toLowerCase() : parseFloat(a[Object.keys(a)[sortCol]] || 0);
    let B = sortCol === 0 ? b.sym.toLowerCase() : parseFloat(b[Object.keys(b)[sortCol]] || 0);
    if (sortCol === 0) {
      return asc ? A.localeCompare(B) : B.localeCompare(A);
    }
    return asc ? (A - B) : (B - A);
  });

  // Sort arrows
  document.querySelectorAll("th[onclick]").forEach((th, i) => {
    const txt = th.innerText.replace(/[^\w\s%]/g, "");
    th.innerHTML = txt + (i === sortCol ? (asc ? " ↑" : " ↓") : "");
  });

  tbody.innerHTML = rows.map(c => {
    const sym = c.sym;
    const display = sym === "1MBABYDOGE" ? "1M BabyDoge" : sym;
    const vs = c.vsAvg.toFixed(2);
    const prof = calcProfit(sym);
    const profitHTML = prof.profit !== 0
      ? `<span class="${prof.profit >= 0 ? 'pos' : 'neg'}">$${prof.profit.toFixed(2)} <small>(${prof.pct >= 0 ? '+' : ''}${prof.pct.toFixed(2)}%)</small></span>`
      : `<span class="zero">$0.00</span>`;

    return `
      <tr style="cursor:pointer;" onclick="if(event.target.classList.contains('symbol')){event.stopPropagation();window.open('https://www.binance.com/en/trade/${sym}_USDT?type=spot','_blank');}else{openRow(this);}">
        <td><span class="symbol">${display}</span></td>
        <td class="${c.vsAvg >= 0 ? 'pos' : 'neg'}">${c.vsAvg >= 0 ? '+' : ''}${vs}%</td>
        <td class="${c.change24h >= 0 ? 'pos' : 'neg'}">${c.change24h.toFixed(2)}%</td>
        <td class="${c.change7d >= 0 ? 'pos' : 'neg'}">${c.change7d.toFixed(2)}%</td>
        <td class="${c.change30d >= 0 ? 'pos' : 'neg'}">${c.change30d.toFixed(2)}%</td>
        <td style="font-weight:bold">${formatPrice(c.price)}</td>
        <td>${formatPrice(c.avgPrice)}</td>
        <td>${formatPrice(c.avgHigh)}</td>
        <td>${formatPrice(c.avgLow)}</td>
        <td>${profitHTML}</td>
      </tr>
      <tr class="details" id="det-${sym}" style="display:none;"><td colspan="10" style="padding:0;">
        <div style="padding:20px;background:#0d1117;">
          <strong>Buy / Sell ${display}</strong><br><br>
          Current price: <b>${formatPrice(c.price)}</b><br><br>
          USDT amount: <input type="number" class="amt" id="in-${sym}" value="1000" min="1" step="0.01">
          <button class="buy-btn" onclick="buy('${sym}');event.stopPropagation();">BUY</button>
          <button class="sell-btn" onclick="sell('${sym}');event.stopPropagation();">SELL ALL</button>
          <div style="margin-top:15px;font-size:18px;" id="msg-${sym}"></div>
          <button class="btn" style="background:#da3633;width:100%;margin-top:10px;" onclick="closeAll();">Close</button>
        </div>
      </td></tr>`;
  }).join("");

  updateColVisibility();
  document.querySelectorAll(".details").forEach(r => r.style.display = "none");
}

function openRow(tr) {
  closeAll();
  const next = tr.nextElementSibling;
  if (next) next.style.display = "table-row";
}

function closeAll() {
  document.querySelectorAll(".details").forEach(r => r.style.display = "none");
}

function buy(sym) {
  const coin = data[sym + "USDT"] || Object.values(data).find(c => c.sym === sym);
  const usdt = parseFloat(document.getElementById(`in-${sym}`).value) || 0;
  if (usdt <= 0) return alert("Enter amount > 0");
  const coins = usdt / coin.price;
  positions[sym] = {coins, buyPrice: coin.price};
  save();
  document.getElementById(`msg-${sym}`).innerHTML = `<span style="color:#26a641">Bought ${coins.toFixed(6)} ${sym} @ ${formatPrice(coin.price)}</span>`;
  render();
}

function sell(sym) {
  if (!positions[sym] || positions[sym].coins === 0) {
    document.getElementById(`msg-${sym}`).textContent = "Nothing to sell";
    return;
  }
  const coin = data[sym + "USDT"] || Object.values(data).find(c => c.sym === sym);
  const profit = (coin.price - positions[sym].buyPrice) * positions[sym].coins;
  const pct = ((coin.price - positions[sym].buyPrice) / positions[sym].buyPrice) * 100;
  document.getElementById(`msg-${sym}`).innerHTML = `<span style="color:${profit >= 0 ? '#26a641' : '#da3633'}">Sold → Profit: $${profit.toFixed(2)} (${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%)</span>`;
  delete positions[sym];
  save();
  render();
}

function sort(n) {
  if (sortCol === n) asc = !asc;
  else { sortCol = n; asc = n === 1 ? false : true; }
  render();
}

function updateColVisibility() {
  const colMap = {changes: 1, '24h': 2, '7d': 3, '30d': 4, price: 5, avg: 6, high: 7, low: 8};
  Object.keys(visibleCols).forEach(key => {
    const idx = colMap[key];
    if (idx) {
      const th = document.querySelector(`th[onclick="sort(${idx})"]`);
      if (th) th.style.display = visibleCols[key] ? 'table-cell' : 'none';
      document.querySelectorAll(`td:nth-child(${idx + 1})`).forEach(td => td.style.display = visibleCols[key] ? 'table-cell' : 'none');
    }
  });
  // Profit column (last)
  const profitTh = document.querySelector('th:last-child');
  if (profitTh) profitTh.style.display = visibleCols.profit ? 'table-cell' : 'none';
  document.querySelectorAll('tbody td:last-child').forEach(td => td.style.display = visibleCols.profit ? 'table-cell' : 'none');
}

function addCoin() {
  const input = document.getElementById("newSymbol");
  let sym = input.value.trim().toUpperCase();
  if (!sym.endsWith("USDT")) sym += "USDT";
  if (myCoins.includes(sym)) return alert("Already added!");
  if (!sym || sym.length < 5) return alert("Enter valid symbol (e.g., PEPEUSDT)");
  myCoins.push(sym);
  input.value = "";
  save();
  refreshData(true); // Fetch new coin
  renderCoinList();
  alert(`${sym} added!`);
}

function removeCoin(sym) {
  myCoins = myCoins.filter(x => x !== sym);
  delete data[sym];
  delete positions[sym.replace("USDT", "")];
  save();
  render();
  renderCoinList();
}

function renderCoinList() {
  document.getElementById("coinList").innerHTML = myCoins.map(s => `
    <div class="coin-item">
      <span>${s}</span>
      <button class="remove" onclick="removeCoin('${s}')">Remove</button>
    </div>`).join("");
}

function togglePanel(id) {
  document.querySelectorAll(".panel").forEach(p => p.style.display = "none");
  const panel = document.getElementById(id);
  const isOpen = panel.style.display === "block";
  panel.style.display = isOpen ? "none" : "block";
  if (id === "managePanel" && !isOpen) renderCoinList();
}

// Column toggles
document.addEventListener('change', e => {
  if (e.target.type === 'checkbox' && e.target.dataset.col) {
    visibleCols[e.target.dataset.col] = e.target.checked;
    save();
    render();
  }
});

window.onload = () => {
  load();
  if (myCoins.length === 0) refreshData(true);
  else render();
};
</script>
</body>
</html>
